{% extends 'base/base.html' %}
{% load static %}

{% block title %}Dashboard - {{ chauffeur.nom_complet }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="bi bi-speedometer2"></i> 
                Bonjour {{ chauffeur.prenom }} !
            </h2>
            <div class="d-flex align-items-center gap-3">
                <!-- Menu principal avec toutes les options -->
                <div class="dropdown">
                    <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-gear"></i> Menu
                    </button>
                    <ul class="dropdown-menu">
                        <li>
                            <h6 class="dropdown-header">
                                <i class="bi bi-person"></i> Mon compte
                            </h6>
                        </li>
                        <li>
                            <a class="dropdown-item" href="{% url 'drivers:mon_compte' %}">
                                <i class="bi bi-person-gear text-primary"></i> Modifier mon compte
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <h6 class="dropdown-header">
                                <i class="bi bi-pencil-square"></i> Modifications
                            </h6>
                        </li>
                        <li>
                            <a class="dropdown-item" href="{% url 'drivers:demander_modification' %}">
                                <i class="bi bi-pencil-square text-warning"></i> Demander modification
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="{% url 'drivers:mes_demandes' %}">
                                <i class="bi bi-list-check text-info"></i> Mes demandes
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <h6 class="dropdown-header">
                                <i class="bi bi-printer"></i> Export
                            </h6>
                        </li>
                        <li>
                            <a class="dropdown-item" href="{% url 'drivers:exporter_pdf' %}" target="_blank">
                                <i class="bi bi-file-pdf text-danger"></i> Télécharger PDF
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="#" onclick="partagerWhatsApp()">
                                <i class="bi bi-whatsapp text-success"></i> Partager sur WhatsApp
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="#" onclick="partagerGmail()">
                                <i class="bi bi-envelope text-primary"></i> Envoyer par Gmail
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="#" onclick="partagerTelegram()">
                                <i class="bi bi-telegram text-info"></i> Partager sur Telegram
                            </a>
                        </li>
                    </ul>
                </div>
                <span class="badge bg-success fs-6">
                    <i class="bi bi-person-check"></i> Chauffeur actif
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Actions rapides -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-lightning"></i> Actions du jour
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    {% if peut_prendre_cles %}
                    <div class="col-md-6">
                        <a href="{% url 'drivers:prendre_cles' %}" class="btn btn-success btn-lg w-100">
                            <i class="bi bi-key-fill"></i> Prendre les clés
                            <small class="d-block">Début de journée</small>
                        </a>
                    </div>
                    {% elif peut_remettre_cles %}
                    <div class="col-md-6">
                        <a href="{% url 'drivers:remettre_cles' %}" class="btn btn-warning btn-lg w-100">
                            <i class="bi bi-key"></i> Remettre les clés
                            <small class="d-block">Fin de journée</small>
                        </a>
                    </div>
                    {% elif nouvelle_activite_possible %}
                    <div class="col-md-6">
                        <a href="{% url 'drivers:prendre_cles' %}" class="btn btn-primary btn-lg w-100">
                            <i class="bi bi-plus-circle"></i> Nouvelle activité
                            <small class="d-block">Disponible à partir de 3h</small>
                        </a>
                    </div>
                    {% else %}
                    <div class="col-md-6">
                        <div class="btn btn-secondary btn-lg w-100 disabled">
                            <i class="bi bi-check-circle"></i> Journée terminée
                            <small class="d-block">Clés prises et remises</small>
                        </div>
                    </div>
                    {% endif %}
                    <div class="col-md-6">
                        <a href="{% url 'drivers:activite_mensuelle' %}" class="btn btn-info btn-lg w-100">
                            <i class="bi bi-calendar-month"></i> Voir l'activité du mois
                            <small class="d-block">Calendrier et statistiques</small>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statut actuel -->
<div class="row mb-4">
    <div class="col-12">
        {% if prise_aujourdhui %}
        <div class="alert alert-success">
            <h6><i class="bi bi-check-circle"></i> Clés prises aujourd'hui</h6>
            <p class="mb-0">
                <strong>Heure :</strong> {{ prise_aujourdhui.heure_prise|time:"H:i" }}<br>
                <strong>Objectif :</strong> {{ prise_aujourdhui.objectif_recette }} FCFA<br>
                <strong>Carburant :</strong> {% if prise_aujourdhui.plein_carburant %}Plein{% else %}À faire{% endif %}<br>
                {% if prise_aujourdhui.probleme_mecanique != "Aucun" %}
                <strong>Problème :</strong> {{ prise_aujourdhui.probleme_mecanique }}
                {% endif %}
            </p>
        </div>
        {% endif %}
        
        {% if remise_aujourdhui %}
        <div class="alert alert-info">
            <h6><i class="bi bi-check-circle-fill"></i> Clés remises aujourd'hui</h6>
            <p class="mb-0">
                <strong>Heure :</strong> {{ remise_aujourdhui.heure_remise|time:"H:i" }}<br>
                <strong>Recette :</strong> {{ remise_aujourdhui.recette_realisee }} FCFA<br>
                <strong>Carburant :</strong> {% if remise_aujourdhui.plein_carburant %}Plein{% else %}À faire{% endif %}
            </p>
        </div>
        {% endif %}
        
        {% if not prise_aujourdhui and not remise_aujourdhui %}
        <div class="alert alert-light">
            <h6><i class="bi bi-clock"></i> Aucune activité aujourd'hui</h6>
            <p class="mb-0">Commencez votre journée en prenant les clés !</p>
        </div>
        {% endif %}
    </div>
</div>

<div class="row">
    <!-- Activités récentes de la semaine -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history"></i> Activités récentes de la semaine
                </h5>
            </div>
            <div class="card-body">
                {% if activites_recentes %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date/Heure</th>
                                    <th>Type</th>
                                    <th>Détails</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for activite in activites_recentes %}
                                <tr>
                                    <td>{{ activite.date_heure|date:"d/m/Y H:i" }}</td>
                                    <td>
                                        {% if activite.type_activite == 'prise' %}
                                            <span class="badge bg-success">
                                                <i class="bi bi-key-fill"></i> Prise
                                            </span>
                                        {% else %}
                                            <span class="badge bg-warning">
                                                <i class="bi bi-key"></i> Remise
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if activite.type_activite == 'prise' %}
                                            <strong>Objectif:</strong> {{ activite.objectif_recette|floatformat:0 }} FCFA<br>
                                            <small class="text-muted">
                                                <i class="bi bi-fuel-pump"></i> 
                                                {% if activite.plein_carburant %}Plein{% else %}À faire{% endif %}
                                                {% if activite.probleme_mecanique != 'Aucun' %}
                                                    | <i class="bi bi-exclamation-triangle"></i> {{ activite.probleme_mecanique }}
                                                {% endif %}
                                            </small>
                                        {% else %}
                                            <strong>Recette:</strong> {{ activite.recette_realisee|floatformat:0 }} FCFA<br>
                                            <small class="text-muted">
                                                <i class="bi bi-fuel-pump"></i> 
                                                {% if activite.plein_carburant %}Plein{% else %}À faire{% endif %}
                                                {% if activite.probleme_mecanique != 'Aucun' %}
                                                    | <i class="bi bi-exclamation-triangle"></i> {{ activite.probleme_mecanique }}
                                                {% endif %}
                                            </small>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination des activités récentes -->
                    {% if activites_paginator.num_pages > 1 %}
                    <nav aria-label="Pagination des activités">
                        <ul class="pagination pagination-sm justify-content-center mt-3">
                            {% if activites_recentes.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ activites_recentes.previous_page_number }}">Précédent</a>
                                </li>
                            {% endif %}
                            
                            {% for num in activites_paginator.page_range %}
                                {% if activites_recentes.number == num %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ num }}</span>
                                    </li>
                                {% else %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if activites_recentes.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ activites_recentes.next_page_number }}">Suivant</a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                {% else %}
                    <p class="text-muted text-center">Aucune activité récente</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Recettes de la semaine -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-graph-up"></i> Recettes de la semaine
                </h5>
            </div>
            <div class="card-body">
                {% if recettes_semaine %}
                    <!-- Statistiques de la semaine -->
                    <div class="row mb-3">
                        <div class="col-6">
                            <div class="text-center">
                                <h6 class="text-muted mb-1">Total</h6>
                                <h4 class="text-success mb-0">{{ total_semaine|floatformat:0 }} FCFA</h4>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <h6 class="text-muted mb-1">Moyenne/jour</h6>
                                <h4 class="text-primary mb-0">{{ moyenne_semaine|floatformat:0 }} FCFA</h4>
                                <small class="text-muted">{{ nombre_jours_travailles }} jour{{ nombre_jours_travailles|pluralize }} travaillé{{ nombre_jours_travailles|pluralize }}</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Liste des recettes -->
                    <div class="list-group list-group-flush">
                        {% for recette in recettes_semaine %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <span class="fw-bold">{{ recette.date|date:"d/m" }}</span>
                                <small class="text-muted d-block">
                                    {{ recette.heure_remise|time:"H:i" }}
                                </small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-success rounded-pill">{{ recette.recette_realisee|floatformat:0 }} FCFA</span>
                                {% if recette.plein_carburant %}
                                    <i class="bi bi-fuel-pump-fill text-success ms-1" title="Plein effectué"></i>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center">
                        <i class="bi bi-graph-up text-muted" style="font-size: 3rem;"></i>
                        <p class="text-muted mt-2">Aucune recette cette semaine</p>
                        <small class="text-muted">Commencez à enregistrer vos activités !</small>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>


<script>
// Fonctions de partage sur les réseaux sociaux
function partagerWhatsApp() {
    const message = `🚕 *Rapport d'Activité - Gaboma Drive*\n\n` +
                   `Bonjour ! Voici mon rapport d'activité de la semaine.\n` +
                   `📊 Total recettes: {{ total_semaine|floatformat:0 }} FCFA\n` +
                   `📈 Moyenne journalière: {{ moyenne_semaine|floatformat:0 }} FCFA\n` +
                   `📅 Jours travaillés: {{ recettes_semaine|length }}/7\n\n` +
                   `Téléchargez le rapport complet en PDF :\n` +
                   `{{ request.build_absolute_uri }}{% url 'drivers:exporter_pdf' %}`;
    
    const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
    window.open(url, '_blank');
}

function partagerGmail() {
    const subject = `Rapport d'Activité - {{ chauffeur.prenom }} {{ chauffeur.nom }} - Semaine du {{ today|date:"d/m/Y" }}`;
    const body = `Bonjour,\n\n` +
                `Veuillez trouver ci-joint mon rapport d'activité de la semaine.\n\n` +
                `📊 Résumé de la semaine :\n` +
                `• Total recettes: {{ total_semaine|floatformat:0 }} FCFA\n` +
                `• Moyenne journalière: {{ moyenne_semaine|floatformat:0 }} FCFA\n` +
                `• Jours travaillés: {{ recettes_semaine|length }}/7\n\n` +
                `Le rapport complet en PDF est disponible ici :\n` +
                `{{ request.build_absolute_uri }}{% url 'drivers:exporter_pdf' %}\n\n` +
                `Cordialement,\n` +
                `{{ chauffeur.prenom }} {{ chauffeur.nom }}\n` +
                `Chauffeur - Gaboma Drive`;
    
    const url = `https://mail.google.com/mail/?view=cm&fs=1&to=&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.open(url, '_blank');
}

function partagerTelegram() {
    const message = `🚕 *Rapport d'Activité - Gaboma Drive*\n\n` +
                   `📊 *Résumé de la semaine :*\n` +
                   `• Total recettes: {{ total_semaine|floatformat:0 }} FCFA\n` +
                   `• Moyenne journalière: {{ moyenne_semaine|floatformat:0 }} FCFA\n` +
                   `• Jours travaillés: {{ recettes_semaine|length }}/7\n\n` +
                   `📄 *Rapport complet :*\n` +
                   `{{ request.build_absolute_uri }}{% url 'drivers:exporter_pdf' %}\n\n` +
                   `_Généré automatiquement par Gaboma Drive_`;
    
    const url = `https://t.me/share/url?url=${encodeURIComponent('{{ request.build_absolute_uri }}{% url "drivers:exporter_pdf" %}')}&text=${encodeURIComponent(message)}`;
    window.open(url, '_blank');
}

// Animation du bouton d'export
document.addEventListener('DOMContentLoaded', function() {
    const exportBtn = document.querySelector('[data-bs-toggle="dropdown"]');
    if (exportBtn) {
        exportBtn.addEventListener('click', function() {
            this.classList.add('btn-primary');
            this.classList.remove('btn-outline-primary');
            setTimeout(() => {
                this.classList.remove('btn-primary');
                this.classList.add('btn-outline-primary');
            }, 200);
        });
    }
});
</script>
{% endblock %}
