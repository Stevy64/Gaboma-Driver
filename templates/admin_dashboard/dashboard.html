{% extends 'base/base.html' %}
{% load static %}

{% block title %}Dashboard Admin - Gaboma Driver{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">
            <i class="bi bi-speedometer2"></i> Dashboard Administrateur
        </h2>
    </div>
</div>

<!-- Menu de Navigation Rapide -->
<div class="row g-3 mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-grid-3x3-gap me-2"></i> Navigation Rapide
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- Première ligne - 4 éléments -->
                    <div class="col-6 col-md-3">
                        <a href="{% url 'admin_dashboard:dashboard_admin' %}" class="text-decoration-none">
                            <div class="card text-center h-100 nav-card">
                                <div class="card-body p-3">
                                    <i class="bi bi-speedometer2 text-primary mb-2" style="font-size: 2rem;"></i>
                                    <h6 class="card-title mb-0">Dashboard</h6>
                                </div>
                            </div>
                        </a>
                    </div>
                    <div class="col-6 col-md-3">
                        <a href="{% url 'admin_dashboard:liste_chauffeurs' %}" class="text-decoration-none">
                            <div class="card text-center h-100 nav-card">
                                <div class="card-body p-3">
                                    <i class="bi bi-people text-info mb-2" style="font-size: 2rem;"></i>
                                    <h6 class="card-title mb-0">Chauffeurs</h6>
                                </div>
                            </div>
                        </a>
                    </div>
                    <div class="col-6 col-md-3">
                        <a href="{% url 'admin_dashboard:statistiques_recettes' %}" class="text-decoration-none">
                            <div class="card text-center h-100 nav-card">
                                <div class="card-body p-3">
                                    <i class="bi bi-graph-up text-success mb-2" style="font-size: 2rem;"></i>
                                    <h6 class="card-title mb-0">Recettes</h6>
                                </div>
                            </div>
                        </a>
                    </div>
                    <div class="col-6 col-md-3">
                        <a href="{% url 'admin_dashboard:calendrier_activites' %}" class="text-decoration-none">
                            <div class="card text-center h-100 nav-card">
                                <div class="card-body p-3">
                                    <i class="bi bi-calendar3 text-warning mb-2" style="font-size: 2rem;"></i>
                                    <h6 class="card-title mb-0">Calendrier</h6>
                                </div>
                            </div>
                        </a>
                    </div>
                    <!-- Deuxième ligne - 4 éléments -->
                    <div class="col-6 col-md-3">
                        <a href="{% url 'admin_dashboard:gestion_activites' %}" class="text-decoration-none">
                            <div class="card text-center h-100 nav-card">
                                <div class="card-body p-3">
                                    <i class="bi bi-list-task text-primary mb-2" style="font-size: 2rem;"></i>
                                    <h6 class="card-title mb-0">Activités</h6>
                                </div>
                            </div>
                        </a>
                    </div>
                    <div class="col-6 col-md-3">
                        <a href="{% url 'admin_dashboard:gestion_demandes_modification' %}" class="text-decoration-none">
                            <div class="card text-center h-100 nav-card">
                                <div class="card-body p-3">
                                    <i class="bi bi-clipboard-check text-info mb-2" style="font-size: 2rem;"></i>
                                    <h6 class="card-title mb-0">Demandes</h6>
                                </div>
                            </div>
                        </a>
                    </div>
                    <div class="col-6 col-md-3">
                        {% if user.is_superuser or user.is_staff %}
                        <a href="{% url 'admin_dashboard:gestion_superviseurs' %}" class="text-decoration-none">
                            <div class="card text-center h-100 nav-card">
                                <div class="card-body p-3">
                                    <i class="bi bi-people-fill text-success mb-2" style="font-size: 2rem;"></i>
                                    <h6 class="card-title mb-0">Superviseurs</h6>
                                </div>
                            </div>
                        </a>
                        {% else %}
                        <a href="{% url 'admin_dashboard:gestion_pannes' %}" class="text-decoration-none">
                            <div class="card text-center h-100 nav-card">
                                <div class="card-body p-3">
                                    <i class="bi bi-tools text-danger mb-2" style="font-size: 2rem;"></i>
                                    <h6 class="card-title mb-0">Pannes</h6>
                                </div>
                            </div>
                        </a>
                        {% endif %}
                    </div>
                    <div class="col-6 col-md-3">
                        <a href="/admin/" class="text-decoration-none" target="_blank">
                            <div class="card text-center h-100 nav-card">
                                <div class="card-body p-3">
                                    <i class="bi bi-gear text-warning mb-2" style="font-size: 2rem;"></i>
                                    <h6 class="card-title mb-0">Admin</h6>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistiques générales -->
<div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
        <div class="card text-center h-100">
            <div class="card-body p-3">
                <i class="bi bi-people text-primary" style="font-size: 1.5rem;"></i>
                <h5 class="mt-2 mb-1">{{ total_chauffeurs }}</h5>
                <p class="text-muted mb-0 small">Chauffeurs actifs</p>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card text-center h-100">
            <div class="card-body p-3">
                <i class="bi bi-clock text-info" style="font-size: 1.5rem;"></i>
                <h5 class="mt-2 mb-1">{{ total_activites_aujourdhui }}</h5>
                <p class="text-muted mb-0 small">Activités aujourd'hui</p>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card text-center h-100">
            <div class="card-body p-3">
                <i class="bi bi-cash-coin text-success" style="font-size: 1.5rem;"></i>
                <h5 class="mt-2 mb-1">{{ recettes_aujourdhui|floatformat:0 }} FCFA</h5>
                <p class="text-muted mb-0 small">Recettes aujourd'hui</p>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card text-center h-100">
            <div class="card-body p-3">
                <i class="bi bi-tools text-warning" style="font-size: 1.5rem;"></i>
                <h5 class="mt-2 mb-1">{{ pannes_en_cours }}</h5>
                <p class="text-muted mb-0 small">Pannes en cours</p>
            </div>
        </div>
    </div>
</div>

<!-- Recettes et alertes -->
<div class="row g-3 mb-4">
    <div class="col-12 col-lg-8">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-graph-up"></i> Recettes
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center g-3">
                    <div class="col-4 col-md-4">
                        <h4 class="text-success mb-1">{{ recettes_aujourdhui|floatformat:0 }} FCFA</h4>
                        <p class="text-muted small mb-0">Aujourd'hui</p>
                    </div>
                    <div class="col-4 col-md-4">
                        <h4 class="text-info mb-1">{{ recettes_semaine|floatformat:0 }} FCFA</h4>
                        <p class="text-muted small mb-0">Cette semaine</p>
                    </div>
                    <div class="col-4 col-md-4">
                        <h4 class="text-primary mb-1">{{ recettes_mois|floatformat:0 }} FCFA</h4>
                        <p class="text-muted small mb-0">Ce mois</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-12 col-lg-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-exclamation-triangle"></i> Alertes
                </h5>
            </div>
            <div class="card-body">
                {% if pannes_critiques > 0 %}
                <div class="alert alert-danger mb-2">
                    <i class="bi bi-exclamation-triangle"></i>
                    {{ pannes_critiques }} panne(s) critique(s)
                </div>
                {% endif %}
                {% if pannes_en_cours > 0 %}
                <div class="alert alert-warning mb-2">
                    <i class="bi bi-tools"></i>
                    {{ pannes_en_cours }} panne(s) en cours
                </div>
                {% endif %}
                {% if demandes_en_attente > 0 %}
                <div class="alert alert-warning mb-2">
                    <i class="bi bi-clock"></i>
                    {{ demandes_en_attente }} demande(s) de modification en attente
                </div>
                {% endif %}
                {% if pannes_critiques == 0 and pannes_en_cours == 0 and demandes_en_attente == 0 %}
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i>
                    Aucune alerte
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Gestion des Activités et Demandes -->
<div class="row g-3 mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-cogs me-2"></i> Gestion des Activités et Demandes
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card border-primary h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-tasks fa-3x text-primary mb-3"></i>
                                <h5 class="card-title">Gestion des Activités</h5>
                                <p class="card-text">Consultez toutes les activités des chauffeurs avec filtres avancés.</p>
                                <a href="{% url 'admin_dashboard:gestion_activites' %}" class="btn btn-primary">
                                    <i class="bi bi-eye me-1"></i>Voir les Activités
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-warning h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-edit fa-3x text-warning mb-3"></i>
                                <h5 class="card-title">Demandes de Modification</h5>
                                <p class="card-text">Approuvez ou rejetez les demandes de modification d'activité.</p>
                                <a href="{% url 'admin_dashboard:gestion_demandes_modification' %}" class="btn btn-warning">
                                    <i class="bi bi-list me-1"></i>Gérer les Demandes
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-info h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-chart-line fa-3x text-info mb-3"></i>
                                <h5 class="card-title">Statistiques Avancées</h5>
                                <p class="card-text">Analysez les performances et les tendances des chauffeurs.</p>
                                <a href="{% url 'admin_dashboard:statistiques_recettes' %}" class="btn btn-info">
                                    <i class="bi bi-chart-bar me-1"></i>Voir les Stats
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Problèmes mécaniques récents -->
{% if pannes_recentes %}
<div class="row g-3 mt-3">
    <div class="col-12">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-exclamation-triangle"></i> Problèmes mécaniques récents
                </h5>
            </div>
            <div class="card-body">
                <!-- Version Desktop -->
                <div class="table-responsive d-none d-lg-block">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th width="5%">#</th>
                                <th>Chauffeur</th>
                                <th>Description</th>
                                <th>Sévérité</th>
                                <th>Statut</th>
                                <th>Date</th>
                                <th width="10%">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for panne in pannes_recentes %}
                            <tr>
                                <td class="text-muted">{{ forloop.counter|add:pannes_page_obj.start_index|add:"-1" }}</td>
                                <td>
                                    <span class="fw-bold">{{ panne.chauffeur.nom_complet }}</span>
                                </td>
                                <td>
                                    <span class="text-muted">{{ panne.description|truncatechars:50 }}</span>
                                </td>
                                <td>
                                    <span class="badge bg-{% if panne.severite == 'critique' %}danger{% elif panne.severite == 'majeure' %}warning{% elif panne.severite == 'moderee' %}info{% else %}secondary{% endif %}">
                                        {{ panne.get_severite_display }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-{% if panne.statut == 'reparée' %}success{% elif panne.statut == 'en_cours' %}warning{% elif panne.statut == 'signalee' %}primary{% else %}secondary{% endif %}">
                                        {{ panne.get_statut_display }}
                                    </span>
                                </td>
                                <td>
                                    <small class="text-muted">{{ panne.date_creation|date:"d/m/Y" }}</small>
                                </td>
                                <td>
                                    <a href="{% url 'admin_dashboard:supprimer_panne' panne.id %}" 
                                       class="btn btn-outline-danger btn-sm" title="Supprimer la panne" 
                                       onclick="return confirm('Êtes-vous sûr de vouloir supprimer cette panne ?')">
                                        <i class="bi bi-trash me-1"></i>Suppr.
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Version Mobile -->
                <div class="d-lg-none">
                    {% for panne in pannes_recentes %}
                    <div class="card mb-2">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <span class="badge bg-primary me-2">{{ forloop.counter|add:pannes_page_obj.start_index|add:"-1" }}</span>
                                    <strong>{{ panne.chauffeur.nom_complet }}</strong>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-{% if panne.severite == 'critique' %}danger{% elif panne.severite == 'majeure' %}warning{% elif panne.severite == 'moderee' %}info{% else %}secondary{% endif %}">
                                        {{ panne.get_severite_display }}
                                    </span>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-8">
                                    <small class="text-muted">{{ panne.description|truncatechars:40 }}</small>
                                </div>
                                <div class="col-4 text-end">
                                    <span class="badge bg-{% if panne.statut == 'reparée' %}success{% elif panne.statut == 'en_cours' %}warning{% elif panne.statut == 'signalee' %}primary{% else %}secondary{% endif %}">
                                        {{ panne.get_statut_display }}
                                    </span>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-6">
                                    <small class="text-muted">{{ panne.date_creation|date:"d/m/Y" }}</small>
                                </div>
                                <div class="col-6 text-end">
                                    <a href="{% url 'admin_dashboard:supprimer_panne' panne.id %}" 
                                       class="btn btn-outline-danger btn-sm" title="Supprimer la panne" 
                                       onclick="return confirm('Êtes-vous sûr de vouloir supprimer cette panne ?')">
                                        <i class="bi bi-trash me-1"></i>Suppr.
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Pagination pour les pannes récentes -->
                {% if pannes_page_obj.has_other_pages %}
                <nav aria-label="Pagination des pannes récentes" class="mt-3">
                    <ul class="pagination pagination-sm justify-content-center">
                        {% if pannes_page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?pannes_page={{ pannes_page_obj.previous_page_number }}">Précédent</a>
                            </li>
                        {% endif %}
                        
                        <li class="page-item active">
                            <span class="page-link">
                                Page {{ pannes_page_obj.number }} sur {{ pannes_page_obj.paginator.num_pages }}
                            </span>
                        </li>
                        
                        {% if pannes_page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?pannes_page={{ pannes_page_obj.next_page_number }}">Suivant</a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="row g-3">
    <!-- Activités récentes -->
    <div class="col-12">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history"></i> Activités récentes
                </h5>
            </div>
            <div class="card-body">
                {% if activites_recentes %}
                    <!-- Version Desktop -->
                    <div class="table-responsive d-none d-lg-block">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th width="5%">#</th>
                                    <th>Chauffeur</th>
                                    <th>Type</th>
                                    <th>Heure</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for activite in activites_recentes %}
                                <tr>
                                    <td class="text-muted">{{ forloop.counter|add:activites_page_obj.start_index|add:"-1" }}</td>
                                    <td>
                                        <span class="fw-bold">{{ activite.chauffeur.nom_complet }}</span>
                                    </td>
                                    <td>
                                        {% if activite.type_activite == 'prise' %}
                                            <span class="badge bg-success">Prise</span>
                                        {% else %}
                                            <span class="badge bg-warning">Remise</span>
                                        {% endif %}
                                    </td>
                                    <td class="fw-bold">
                                        <i class="bi bi-clock me-1"></i>{{ activite.date_heure|date:"H:i" }}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Version Mobile -->
                    <div class="d-lg-none">
                        {% for activite in activites_recentes %}
                        <div class="card mb-2">
                            <div class="card-body py-2">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <span class="badge bg-primary me-2">{{ forloop.counter|add:activites_page_obj.start_index|add:"-1" }}</span>
                                        <strong>{{ activite.chauffeur.nom_complet }}</strong>
                                    </div>
                                    {% if activite.type_activite == 'prise' %}
                                        <span class="badge bg-success">Prise</span>
                                    {% else %}
                                        <span class="badge bg-warning">Remise</span>
                                    {% endif %}
                                </div>
                                <div class="mt-1">
                                    <small class="text-muted">
                                        <i class="bi bi-clock me-1"></i>{{ activite.date_heure|date:"H:i" }}
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Pagination pour les activités récentes -->
                    {% if activites_page_obj.has_other_pages %}
                    <nav aria-label="Pagination des activités récentes" class="mt-3">
                        <ul class="pagination pagination-sm justify-content-center">
                            {% if activites_page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?activites_page={{ activites_page_obj.previous_page_number }}">Précédent</a>
                                </li>
                            {% endif %}
                            
                            <li class="page-item active">
                                <span class="page-link">
                                    Page {{ activites_page_obj.number }} sur {{ activites_page_obj.paginator.num_pages }}
                                </span>
                            </li>
                            
                            {% if activites_page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?activites_page={{ activites_page_obj.next_page_number }}">Suivant</a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                {% else %}
                    <p class="text-muted text-center">Aucune activité récente</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>


{% endblock %}
