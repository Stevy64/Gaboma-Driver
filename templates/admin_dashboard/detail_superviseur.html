{% extends 'base/base.html' %}
{% load static %}

{% block title %}Détail Superviseur - {{ superviseur.get_full_name|default:superviseur.username }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- En-tête -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-0">
                        <i class="bi bi-person-badge text-primary me-2"></i>
                        Détail du Superviseur
                    </h2>
                    <p class="text-muted mb-0">
                        <strong>{{ superviseur.get_full_name|default:superviseur.username }}</strong>
                        {% if superviseur.is_superuser %}
                            <span class="badge bg-danger ms-2">Super Admin</span>
                        {% endif %}
                    </p>
                </div>
                <div>
                    <a href="{% url 'admin_dashboard:gestion_superviseurs' %}" class="btn btn-outline-secondary me-2">
                        <i class="bi bi-arrow-left"></i> Retour
                    </a>
                    <a href="{% url 'admin_dashboard:assigner_chauffeurs' superviseur.id %}" class="btn btn-primary">
                        <i class="bi bi-person-check"></i> Assigner des Chauffeurs
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Messages d'alerte -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                <i class="bi bi-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-triangle{% else %}info-circle{% endif %}"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Informations du superviseur -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-person-circle me-2"></i>
                        Informations Personnelles
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-sm-4">
                            <strong>Nom d'utilisateur:</strong>
                        </div>
                        <div class="col-sm-8">
                            {{ superviseur.username }}
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-sm-4">
                            <strong>Nom complet:</strong>
                        </div>
                        <div class="col-sm-8">
                            {{ superviseur.get_full_name|default:"Non renseigné" }}
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-sm-4">
                            <strong>Email:</strong>
                        </div>
                        <div class="col-sm-8">
                            {{ superviseur.email|default:"Non renseigné" }}
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-sm-4">
                            <strong>Dernière connexion:</strong>
                        </div>
                        <div class="col-sm-8">
                            {% if superviseur.last_login %}
                                {{ superviseur.last_login|date:"d/m/Y H:i" }}
                            {% else %}
                                <span class="text-muted">Jamais</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-sm-4">
                            <strong>Membre depuis:</strong>
                        </div>
                        <div class="col-sm-8">
                            {{ superviseur.date_joined|date:"d/m/Y H:i" }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up me-2"></i>
                        Statistiques du Mois
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="border-end">
                                <h3 class="text-primary mb-0">{{ stats.total_chauffeurs }}</h3>
                                <small class="text-muted">Chauffeurs assignés</small>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <h3 class="text-success mb-0">{{ stats.total_prises_mois }}</h3>
                            <small class="text-muted">Prises ce mois</small>
                        </div>
                        <div class="col-6">
                            <h3 class="text-info mb-0">{{ stats.total_remises_mois }}</h3>
                            <small class="text-muted">Remises ce mois</small>
                        </div>
                        <div class="col-6">
                            <h3 class="text-warning mb-0">{{ stats.recettes_mois|floatformat:0 }} FCFA</h3>
                            <small class="text-muted">Recettes ce mois</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chauffeurs assignés -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-people me-2"></i>
                        Chauffeurs Assignés ({{ chauffeurs_assignes.count }})
                    </h5>
                </div>
                <div class="card-body">
                    {% if chauffeurs_assignes %}
                        <!-- Version Desktop -->
                        <div class="table-responsive d-none d-lg-block">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th width="5%">#</th>
                                        <th>Nom complet</th>
                                        <th>Téléphone</th>
                                        <th>Email</th>
                                        <th>Statut</th>
                                        <th>Date d'assignation</th>
                                        <th width="15%">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for chauffeur in chauffeurs_assignes %}
                                    <tr>
                                        <td class="text-muted">{{ forloop.counter }}</td>
                                        <td>
                                            <strong>{{ chauffeur.nom_complet }}</strong>
                                        </td>
                                        <td>{{ chauffeur.telephone }}</td>
                                        <td>{{ chauffeur.email|default:"-" }}</td>
                                        <td>
                                            {% if chauffeur.actif %}
                                                <span class="badge bg-success">Actif</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Inactif</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% for assignation in chauffeur.assignations.all %}
                                                {% if assignation.superviseur == superviseur %}
                                                    {{ assignation.date_assignation|date:"d/m/Y H:i" }}
                                                {% endif %}
                                            {% endfor %}
                                        </td>
                                        <td>
                                            <a href="{% url 'admin_dashboard:activites_chauffeur' chauffeur.id %}" 
                                               class="btn btn-outline-primary btn-sm"
                                               title="Voir les activités">
                                                <i class="bi bi-eye"></i> Voir
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Version Mobile -->
                        <div class="d-lg-none">
                            {% for chauffeur in chauffeurs_assignes %}
                            <div class="card mb-3">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="card-title mb-0">
                                            <span class="badge bg-primary me-2">{{ forloop.counter }}</span>
                                            {{ chauffeur.nom_complet }}
                                        </h6>
                                        {% if chauffeur.actif %}
                                            <span class="badge bg-success">Actif</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Inactif</span>
                                        {% endif %}
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <small class="text-muted">Téléphone:</small><br>
                                            <span>{{ chauffeur.telephone }}</span>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Email:</small><br>
                                            <span>{{ chauffeur.email|default:"-" }}</span>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">Assigné le:</small><br>
                                        {% for assignation in chauffeur.assignations.all %}
                                            {% if assignation.superviseur == superviseur %}
                                                {{ assignation.date_assignation|date:"d/m/Y H:i" }}
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                    <div class="mt-3">
                                        <a href="{% url 'admin_dashboard:activites_chauffeur' chauffeur.id %}" 
                                           class="btn btn-outline-primary btn-sm">
                                            <i class="bi bi-eye me-1"></i>Voir les activités
                                        </a>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-people text-muted" style="font-size: 3rem;"></i>
                            <h5 class="text-muted mt-3">Aucun chauffeur assigné</h5>
                            <p class="text-muted">Ce superviseur n'a pas encore de chauffeurs assignés.</p>
                            <a href="{% url 'admin_dashboard:assigner_chauffeurs' superviseur.id %}" class="btn btn-primary">
                                <i class="bi bi-person-plus me-2"></i>Assigner des chauffeurs
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Activités récentes -->
    {% if activites_recentes %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history me-2"></i>
                        Activités Récentes
                    </h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        {% for activite in activites_recentes %}
                        <div class="list-group-item d-flex justify-content-between align-items-start">
                            <div class="ms-2 me-auto">
                                <div class="fw-bold">
                                    <i class="{{ activite.icon }} me-2"></i>
                                    {{ activite.type }}
                                </div>
                                <div class="text-muted">
                                    {{ activite.chauffeur }} - {{ activite.details }}
                                </div>
                            </div>
                            <small class="text-muted">
                                {{ activite.date_heure|date:"d/m/Y H:i" }}
                            </small>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Améliorer l'affichage des messages
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(alert => {
        alert.style.opacity = '0';
        alert.style.transform = 'translateY(-20px)';
        
        setTimeout(() => {
            alert.style.transition = 'all 0.3s ease';
            alert.style.opacity = '1';
            alert.style.transform = 'translateY(0)';
        }, 100);
    });
});
</script>
{% endblock %}

